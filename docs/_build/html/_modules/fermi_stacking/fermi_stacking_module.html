
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>fermi_stacking.fermi_stacking_module &#8212; fermi_stacking  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for fermi_stacking.fermi_stacking_module</h1><div class="highlight"><pre>
<span></span><span class="c1">############################################################</span>
<span class="c1"># </span>
<span class="c1"># Written by Chris karwin; April 2022; Clemson University.</span>
<span class="c1">#</span>
<span class="c1"># Based on original code from Marco Ajello, Vaidehi Paliya, and Abhishek Desai.</span>
<span class="c1">#</span>
<span class="c1"># Purpose: Main script for Fermi-LAT stacking analysis.</span>
<span class="c1">#</span>
<span class="c1">###########################################################</span>

<span class="c1">########################################</span>
<span class="c1"># Imports</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="kn">import</span> <span class="nn">resource</span>
<span class="kn">import</span> <span class="nn">random</span><span class="o">,</span><span class="nn">shutil</span><span class="o">,</span><span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> 
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;TkAgg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">fermipy.gtanalysis</span> <span class="kn">import</span> <span class="n">GTAnalysis</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">pyLikelihood</span> 
<span class="kn">from</span> <span class="nn">BinnedAnalysis</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
<span class="kn">import</span> <span class="nn">matplotlib.mlab</span> <span class="k">as</span> <span class="nn">mlab</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.filters</span> <span class="kn">import</span> <span class="n">gaussian_filter</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">convolve</span><span class="p">,</span> <span class="n">Gaussian2DKernel</span>
<span class="kn">from</span> <span class="nn">matplotlib.cm</span> <span class="kn">import</span> <span class="n">register_cmap</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span><span class="p">,</span> <span class="n">interpolate</span><span class="p">,</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="nn">scipy.stats.contingency</span> <span class="kn">import</span> <span class="n">margins</span>
<span class="kn">import</span> <span class="nn">fermi_stacking.pop_studies</span> <span class="k">as</span> <span class="nn">PS</span>
<span class="kn">from</span> <span class="nn">IntegralUpperLimit</span> <span class="kn">import</span> <span class="n">calc_int</span>
<span class="kn">from</span> <span class="nn">UpperLimits</span> <span class="kn">import</span> <span class="n">UpperLimits</span>
<span class="kn">from</span> <span class="nn">SummedLikelihood</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="c1">#######################################</span>

<span class="c1"># Superclass:</span>
<div class="viewcode-block" id="StackingAnalysis"><a class="viewcode-back" href="../../fermi_stacking.html#fermi_stacking.fermi_stacking_module.StackingAnalysis">[docs]</a><span class="k">class</span> <span class="nc">StackingAnalysis</span><span class="p">:</span>
   
    <span class="sd">&quot;&quot;&quot;Main inputs are specified in inputs.yaml file&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">input_yaml</span><span class="p">):</span>

        <span class="c1"># Get home directory:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
	
        <span class="c1"># Load main inputs from yaml file:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_yaml</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>

        <span class="c1"># Main default inputs:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ft1</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;ft1&quot;</span><span class="p">]</span> <span class="c1"># data file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ft2</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;ft2&quot;</span><span class="p">]</span> <span class="c1"># spacecraft file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galdiff</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;galdiff&quot;</span><span class="p">]</span> <span class="c1"># Galactic diffuse model	</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isodiff</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;isodiff&quot;</span><span class="p">]</span> <span class="c1"># isotropic model</span>

        <span class="c1"># ltcube:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ltcube</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;ltcube&quot;</span><span class="p">]</span>
   
        <span class="c1"># Scratch directory:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_scratch</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;use_scratch&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_scratch</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scratch</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;scratch&quot;</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratch</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">scratch</span><span class="p">)</span>
      
        <span class="c1"># Perform joint likelihood analysis (True) or standard analysis (False):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">JLA</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;JLA&quot;</span><span class="p">]</span>
        
        <span class="c1"># Main analysis parameters:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">irfs</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;irfs&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emin</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;emin&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emax</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;emax&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;tmin&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;tmax&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;zmax&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_min</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;index_min&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_max</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;index_max&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux_min</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;flux_min&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux_max</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;flux_max&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_flux_bins</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;num_flux_bins&quot;</span><span class="p">]</span>

        <span class="c1"># Option to run 4FGL sources:</span>
        <span class="c1"># Note: If True, must provide &quot;remove_list.csv&quot; file in run directory, with col1=sample_name, col2=4fgl_name, and no header.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_4fgl</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;delete_4fgl&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_4fgl</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;remove_list.csv&quot;</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;col0&quot;</span><span class="p">,</span><span class="s2">&quot;col1&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_sample_name</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;col0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_4fgl_name</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;col1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        
        <span class="c1"># Additional options:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_plots</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;show_plots&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_sed</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;calc_sed&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logEbins</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;sed_logEbins&quot;</span><span class="p">]</span>

        <span class="c1"># Sample data:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_file</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;sample_file&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_type</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;file_type&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_name</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;column_name&quot;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;fits&quot;</span><span class="p">:</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_file</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_name_list</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_name_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;tab&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_file</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_name_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="c1">################</span>
    <span class="c1"># Preprocessing:</span>

<div class="viewcode-block" id="StackingAnalysis.ang_sep"><a class="viewcode-back" href="../../fermi_stacking.html#fermi_stacking.fermi_stacking_module.StackingAnalysis.ang_sep">[docs]</a>    <span class="k">def</span> <span class="nf">ang_sep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ra0</span><span class="p">,</span> <span class="n">dec0</span><span class="p">,</span> <span class="n">ra1</span><span class="p">,</span> <span class="n">dec1</span><span class="p">):</span>
       
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Calculate angular distance between two points on the sky.</span>

<span class="sd">        Inputs:</span>
<span class="sd">            - ra0, dec0: coordinates of point 1</span>
<span class="sd">            - ra1, dec1: coordinates of point 2 </span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span>
        <span class="n">d0</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">dec0</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">dec1</span>
        <span class="n">r12</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="p">(</span><span class="n">ra0</span> <span class="o">-</span> <span class="n">ra1</span><span class="p">)</span>
        <span class="n">cd0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">d0</span><span class="p">)</span>
        <span class="n">sd0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d0</span><span class="p">)</span>
        <span class="n">cd1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
        <span class="n">sd1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
        <span class="n">cr12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">r12</span><span class="p">)</span>
        <span class="n">sr12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r12</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">cd0</span> <span class="o">*</span> <span class="n">sr12</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">cd1</span> <span class="o">*</span> <span class="n">sd0</span> <span class="o">-</span> <span class="n">sd1</span> <span class="o">*</span> <span class="n">cd0</span> <span class="o">*</span> <span class="n">cr12</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">den</span> <span class="o">=</span> <span class="n">sd0</span> <span class="o">*</span> <span class="n">sd1</span> <span class="o">+</span> <span class="n">cd0</span> <span class="o">*</span> <span class="n">cd1</span> <span class="o">*</span> <span class="n">cr12</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">)</span> <span class="o">/</span> <span class="n">C</span></div>

<div class="viewcode-block" id="StackingAnalysis.run_preprocessing"><a class="viewcode-back" href="../../fermi_stacking.html#fermi_stacking.fermi_stacking_module.StackingAnalysis.run_preprocessing">[docs]</a>    <span class="k">def</span> <span class="nf">run_preprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">srcname</span><span class="p">,</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">):</span>
       
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Perform preprocessing of sources.</span>

<span class="sd">        Inputs:</span>
<span class="sd">            - srcname: name of source (string)</span>
<span class="sd">            - ra: right ascension (float)</span>
<span class="sd">            - dec: declination (float)</span>

<span class="sd">        &quot;&quot;&quot;</span>

	<span class="c1"># Make print statement:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running preprocessing...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
 
        <span class="c1"># Need to specify coordinates as type float</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>

        <span class="c1"># Define main output directory for source:</span>
        <span class="n">preprocess_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span><span class="s2">&quot;Preprocessed_Sources&quot;</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">preprocess_output</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">preprocess_output</span><span class="p">)</span>

        <span class="c1"># Remove src output directory if it already exists:</span>
        <span class="n">src_output_main</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preprocess_output</span><span class="p">,</span><span class="n">srcname</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">src_output_main</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">src_output_main</span><span class="p">)</span>
        <span class="c1"># Make src output directory:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">src_output_main</span><span class="p">)</span>

        <span class="c1"># Define scratch directory for source:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_scratch</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">preprocess_scratch</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratch</span><span class="p">,</span><span class="s2">&quot;Preprocessing&quot;</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">preprocess_scratch</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">preprocess_scratch</span><span class="p">)</span>
            <span class="n">src_scratch</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preprocess_scratch</span><span class="p">,</span><span class="n">srcname</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">src_scratch</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">src_scratch</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">src_scratch</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">src_scratch</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_scratch</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
             <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">src_output_main</span><span class="p">)</span>
        	
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.yaml&#39;</span> <span class="o">%</span> <span class="n">srcname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">yml</span><span class="p">:</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;logging:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  verbosity : 3</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  chatter : 3</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#--------#</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;fileio:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  outdir : output</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  logfile : </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">srcname</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  usescratch : False</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  scratchdir : scratch</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#--------#</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;data:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  evfile : &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">ft1</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  scfile : &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">ft2</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ltcube</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  ltcube : &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">ltcube</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#--------#</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;binning:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  roiwidth : 10</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  binsz : 0.08</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  binsperdec : 8</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#--------#</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;selection:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  emin : </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">emin</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  emax : </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">emax</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  zmax : </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  target : &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">srcname</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  radius : 15</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  tmin : </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  tmax : </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  evclass : 128</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  evtype : 3</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  filter : &#39;DATA_QUAL&gt;0 &amp;&amp; LAT_CONFIG==1&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#--------#</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;gtlike:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>  
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  edisp : True</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  edisp_disable : [&#39;isodiff&#39;]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  irfs : </span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">irfs</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#--------#</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;model:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  src_radius : 15</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  src_roiwidth : 15</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  galdiff : &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">galdiff</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  isodiff : &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">isodiff</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  catalogs :</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    - &#39;4FGL-DR3&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  extdir : &#39;/zfs/astrohe/Software/fermipy_source/lib/python3.9/site-packages/fermipy-1.1.3+2.g21485-py3.9.egg/fermipy/data/catalogs/Extended_12years/&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  sources :</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    - { &#39;name&#39; : &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;ra&#39; : </span><span class="si">%s</span><span class="s2">, &#39;dec&#39; : </span><span class="si">%s</span><span class="s2">, &#39;SpectrumType&#39; : PowerLaw }</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">srcname</span><span class="p">,</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">))</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#--------#</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;plotting:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  format : png</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#--------#</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;sed:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  use_local_index : True</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
	        
            <span class="c1"># Include components for joint likelihood analysis (JLA):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">JLA</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;components:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  - { model: {isodiff: iso_P8R3_SOURCE_V3_PSF0_v1.txt},</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;      selection : { evtype : 4 } }</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  - { model: {isodiff: iso_P8R3_SOURCE_V3_PSF1_v1.txt},</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;      selection : { evtype : 8 } }</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  - { model: {isodiff: iso_P8R3_SOURCE_V3_PSF2_v1.txt},</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;      selection : { evtype : 16 } }</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  - { model: {isodiff: iso_P8R3_SOURCE_V3_PSF3_v1.txt},</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">yml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;      selection : { evtype : 32 } }</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">yml</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
	
        <span class="n">gta</span> <span class="o">=</span> <span class="n">GTAnalysis</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.yaml&#39;</span> <span class="o">%</span> <span class="n">srcname</span><span class="p">,</span><span class="n">logging</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;verbosity&#39;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
    
        <span class="c1"># if rerunning 4fgl source, first delete source from model:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_4fgl</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">delete_sample_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_sample_name</span>
            <span class="n">delete_4fgl_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_4fgl_name</span>
            <span class="k">if</span> <span class="n">srcname</span> <span class="ow">in</span> <span class="n">delete_sample_name</span><span class="p">:</span>
                <span class="n">this_index</span> <span class="o">=</span> <span class="n">srcname</span> <span class="o">==</span> <span class="n">delete_sample_name</span>
                <span class="n">this_name</span> <span class="o">=</span> <span class="n">delete_4fgl_name</span><span class="p">[</span><span class="n">this_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">gta</span><span class="o">.</span><span class="n">delete_source</span><span class="p">(</span><span class="n">this_name</span><span class="p">)</span>

        <span class="n">gta</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">print_roi</span><span class="p">()</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="s1">&#39;galdiff&#39;</span><span class="p">)</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="s1">&#39;isodiff&#39;</span><span class="p">)</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">free_sources</span><span class="p">(</span><span class="n">minmax_ts</span><span class="o">=</span><span class="p">[</span><span class="mi">25</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">pars</span><span class="o">=</span><span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">free_sources</span><span class="p">(</span><span class="n">minmax_ts</span><span class="o">=</span><span class="p">[</span><span class="mi">500</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">distance</span><span class="o">=</span><span class="mf">7.0</span><span class="p">)</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">write_roi</span><span class="p">(</span><span class="s1">&#39;fit_model_1&#39;</span><span class="p">)</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">delete_source</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span>
        <span class="n">model2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Index&#39;</span> <span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s1">&#39;SpatialModel&#39;</span> <span class="p">:</span> <span class="s1">&#39;PointSource&#39;</span><span class="p">}</span>
        <span class="n">finder2</span> <span class="o">=</span> <span class="n">gta</span><span class="o">.</span><span class="n">find_sources</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;find2&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="n">model2</span><span class="p">,</span><span class="n">sqrt_ts_threshold</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
				<span class="n">min_separation</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">sources_per_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
				<span class="n">tsmap_fitter</span><span class="o">=</span><span class="s1">&#39;tsmap&#39;</span><span class="p">)</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">write_roi</span><span class="p">(</span><span class="s1">&#39;fit_model_2&#39;</span><span class="p">)</span>

        <span class="n">names2</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">finder2</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">finder2</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">]))])</span>
        <span class="n">ra_ns2</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">finder2</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">finder2</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">]))])</span>
        <span class="n">dec_ns2</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">finder2</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">finder2</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">]))])</span>
        <span class="n">r95_ns2</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">finder2</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pos_r95&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">finder2</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">]))])</span>
        <span class="n">dist_sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="mi">0</span>
        <span class="n">namee</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
	
	<span class="c1"># Check ang separation if more than one source is found close to ra and dec</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names2</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names2</span><span class="p">)):</span>
                <span class="n">sepp2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ang_sep</span><span class="p">(</span><span class="n">ra_ns2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">dec_ns2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sepp2</span> <span class="o">&lt;</span> <span class="n">r95_ns2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sepp2</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">names2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">sepp2</span><span class="p">,</span><span class="n">r95_ns2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">dist_sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">sepp2</span>
                    <span class="n">namee</span> <span class="o">=</span> <span class="n">names2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">namee</span><span class="p">:</span>                   
            <span class="c1"># Write name of replaced source:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;output/replaced_source_name.txt&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">([</span><span class="n">srcname</span><span class="p">,</span><span class="n">namee</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">srcname</span><span class="o">=</span><span class="n">namee</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gta</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="n">srcname</span><span class="p">,{</span> <span class="s1">&#39;ra&#39;</span> <span class="p">:</span> <span class="n">ra</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span> <span class="p">:</span> <span class="n">dec</span><span class="p">,</span>
        		<span class="s1">&#39;SpectrumType&#39;</span> <span class="p">:</span> <span class="s1">&#39;PowerLaw&#39;</span><span class="p">,</span> <span class="s1">&#39;Index&#39;</span> <span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
        		<span class="s1">&#39;Scale&#39;</span> <span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;Prefactor&#39;</span> <span class="p">:</span> <span class="mf">1e-11</span><span class="p">,</span>
        		<span class="s1">&#39;SpatialModel&#39;</span> <span class="p">:</span> <span class="s1">&#39;PointSource&#39;</span> <span class="p">})</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">print_roi</span><span class="p">()</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="s1">&#39;galdiff&#39;</span><span class="p">)</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">free_sources</span><span class="p">(</span><span class="n">minmax_ts</span><span class="o">=</span><span class="p">[</span><span class="mi">500</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">distance</span><span class="o">=</span><span class="mf">7.0</span><span class="p">)</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">write_roi</span><span class="p">(</span><span class="s1">&#39;fit_model_3&#39;</span><span class="p">)</span>
        
        <span class="c1"># Calculate SED:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_sed</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">gta</span><span class="o">.</span><span class="n">sed</span><span class="p">(</span><span class="n">srcname</span><span class="p">,</span><span class="n">loge_bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logEbins</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;output/fit_model_3.npy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">][</span><span class="n">srcname</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">])</span><span class="o">==</span><span class="s1">&#39;nan&#39;</span><span class="p">:</span>	<span class="c1"># To check non-convergence</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;****************************&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fit has not converged&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;****************************&#39;</span><span class="p">)</span>
            <span class="n">gta</span><span class="o">.</span><span class="n">free_sources</span><span class="p">(</span><span class="n">minmax_ts</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="mi">100</span><span class="p">],</span><span class="n">free</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">gta</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span>
            <span class="n">gta</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">)</span>
            <span class="n">gta</span><span class="o">.</span><span class="n">write_roi</span><span class="p">(</span><span class="s1">&#39;fit_model_3&#39;</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;output/fit_model_3.npy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">][</span><span class="n">srcname</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;****************************&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fit has converged&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;****************************&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;param_values&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">3.0</span><span class="p">:</span>
            <span class="n">model4</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Index&#39;</span> <span class="p">:</span> <span class="mf">2.8</span><span class="p">,</span> <span class="s1">&#39;SpatialModel&#39;</span> <span class="p">:</span> <span class="s1">&#39;PointSource&#39;</span><span class="p">}</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;****************************&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Source still bad TS=</span><span class="si">%s</span><span class="s1"> Index=</span><span class="si">%s</span><span class="s1">?&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">],</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;param_values&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;****************************&#39;</span><span class="p">)</span>
            <span class="n">gta</span><span class="o">.</span><span class="n">delete_source</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span>
            <span class="n">mapp</span><span class="o">=</span><span class="n">gta</span><span class="o">.</span><span class="n">tsmap</span><span class="p">(</span><span class="s1">&#39;fit_no_source_final&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="n">model4</span><span class="p">)</span>
            <span class="n">finder4</span> <span class="o">=</span> <span class="n">gta</span><span class="o">.</span><span class="n">find_sources</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;find4&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="n">model4</span><span class="p">,</span><span class="n">sqrt_ts_threshold</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                      <span class="n">min_separation</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">sources_per_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                      <span class="n">tsmap_fitter</span><span class="o">=</span><span class="s1">&#39;tsmap&#39;</span><span class="p">)</span>
            <span class="n">gta</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="n">srcname</span><span class="p">,{</span> <span class="s1">&#39;ra&#39;</span> <span class="p">:</span> <span class="n">ra</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span> <span class="p">:</span> <span class="n">dec</span><span class="p">,</span>
                	<span class="s1">&#39;SpectrumType&#39;</span> <span class="p">:</span> <span class="s1">&#39;PowerLaw&#39;</span><span class="p">,</span> <span class="s1">&#39;Index&#39;</span> <span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                	<span class="s1">&#39;Scale&#39;</span> <span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;Prefactor&#39;</span> <span class="p">:</span> <span class="mf">1e-11</span><span class="p">,</span>
                	<span class="s1">&#39;SpatialModel&#39;</span> <span class="p">:</span> <span class="s1">&#39;PointSource&#39;</span> <span class="p">})</span>
            <span class="n">gta</span><span class="o">.</span><span class="n">free_sources</span><span class="p">(</span><span class="n">minmax_ts</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">pars</span><span class="o">=</span><span class="s1">&#39;norm&#39;</span><span class="p">,</span><span class="n">distance</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
            <span class="n">gta</span><span class="o">.</span><span class="n">free_sources</span><span class="p">(</span><span class="n">minmax_ts</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">distance</span><span class="o">=</span><span class="mf">7.0</span><span class="p">)</span>
            <span class="n">gta</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span>
            <span class="n">gta</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
            <span class="n">gta</span><span class="o">.</span><span class="n">write_roi</span><span class="p">(</span><span class="s1">&#39;fit_model_3&#39;</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;output/fit_model_3.npy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">][</span><span class="n">srcname</span><span class="p">]</span>

        <span class="n">TS</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span>
        <span class="n">Flux</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;eflux&#39;</span><span class="p">]</span>
        <span class="n">Flux_err</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;eflux_err&#39;</span><span class="p">]</span>
        <span class="n">Flux_UL</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;eflux_ul95&#39;</span><span class="p">]</span>
        <span class="n">Index</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;param_values&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">Index_err</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;param_errors&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Param.txt&#39;</span> <span class="o">%</span> <span class="n">srcname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dist_sep</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Flux</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Flux_err</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Index_err</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Flux_UL</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">TS</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
	 
        <span class="c1"># Calculate likelihood for null hypothesis:</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">JLA</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">iteration_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">JLA</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">iteration_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">iteration_list</span><span class="p">:</span>

            <span class="n">srcmap</span> <span class="o">=</span> <span class="s1">&#39;output/srcmap_0</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span><span class="n">j</span>
            <span class="n">bexpmap</span> <span class="o">=</span> <span class="s1">&#39;output/bexpmap_0</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span><span class="n">j</span>
            <span class="n">xmlfile</span> <span class="o">=</span> <span class="s1">&#39;output/fit_model_3_0</span><span class="si">%s</span><span class="s1">.xml&#39;</span> <span class="o">%</span><span class="n">j</span>
            <span class="n">savexml</span> <span class="o">=</span> <span class="s1">&#39;output/null_likelihood_</span><span class="si">%s</span><span class="s1">.xml&#39;</span><span class="o">%</span><span class="n">j</span>
            <span class="n">savetxt</span> <span class="o">=</span> <span class="s1">&#39;output/null_likelihood_</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span><span class="n">j</span>

            <span class="n">obs</span> <span class="o">=</span> <span class="n">BinnedObs</span><span class="p">(</span><span class="n">srcMaps</span><span class="o">=</span><span class="n">srcmap</span><span class="p">,</span><span class="n">expCube</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ltcube</span><span class="p">,</span><span class="n">binnedExpMap</span><span class="o">=</span><span class="n">bexpmap</span><span class="p">,</span><span class="n">irfs</span><span class="o">=</span><span class="s1">&#39;P8R3_SOURCE_V2&#39;</span><span class="p">)</span>
            <span class="n">like</span> <span class="o">=</span> <span class="n">BinnedAnalysis</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">xmlfile</span><span class="p">,</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;Minuit&#39;</span><span class="p">)</span> 
            <span class="n">like</span><span class="o">.</span><span class="n">deleteSource</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span>
            <span class="n">freeze</span><span class="o">=</span><span class="n">like</span><span class="o">.</span><span class="n">freeze</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">like</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">)):</span>
                <span class="n">freeze</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">like</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;galdiff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Prefactor&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">like</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;galdiff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">like</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;isodiff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Normalization&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">likeobj</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">Minuit</span><span class="p">(</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="p">)</span>
            <span class="n">thisL</span> <span class="o">=</span> <span class="n">like</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">covar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">optObject</span><span class="o">=</span><span class="n">likeobj</span><span class="p">)</span> <span class="c1">#this returns -logL</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="c1">#this returns logL</span>
            <span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">writeXml</span><span class="p">(</span><span class="n">savexml</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*********&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-logL: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thisL</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">()</span> 
	
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">savetxt</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_scratch</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">src_scratch</span><span class="p">,</span><span class="n">src_output_main</span><span class="p">)</span>
    
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">)</span>

        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">make_preprocessing_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Construct empty dataframe:</span>
        <span class="n">df_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="s2">&quot;dist_sep&quot;</span><span class="p">,</span><span class="s2">&quot;flux&quot;</span><span class="p">,</span><span class="s2">&quot;flux_err&quot;</span><span class="p">,</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="s2">&quot;index_err&quot;</span><span class="p">,</span><span class="s2">&quot;flux_ul&quot;</span><span class="p">,</span><span class="s2">&quot;TS&quot;</span><span class="p">])</span>

        <span class="c1"># Fill dataframe:</span>
        <span class="n">missing_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_name_list</span><span class="p">:</span>
	
            <span class="n">srcname</span> <span class="o">=</span> <span class="n">each</span>
            
            <span class="c1"># Check for updated name:</span>
            <span class="n">indir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span><span class="s2">&quot;Preprocessed_Sources&quot;</span><span class="p">,</span><span class="n">srcname</span><span class="p">,</span><span class="s2">&quot;output&quot;</span><span class="p">)</span>
            <span class="n">new_name_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span><span class="s2">&quot;replaced_source_name.txt&quot;</span><span class="p">)</span>
            <span class="n">replace_name</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_name_file</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">new_name_file</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="n">this_list</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">newsrcname</span> <span class="o">=</span> <span class="n">this_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">replace_name</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">src_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">_Param.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">srcname</span><span class="p">,</span><span class="n">srcname</span><span class="p">)</span>
            <span class="n">wdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span><span class="s2">&quot;Preprocessed_Sources&quot;</span><span class="p">,</span><span class="n">src_file</span><span class="p">)</span> 
	    
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">wdir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">replace_name</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">src_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">_Param.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">srcname</span><span class="p">,</span><span class="n">newsrcname</span><span class="p">)</span>
                <span class="n">wdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span><span class="s2">&quot;Preprocessed_Sources&quot;</span><span class="p">,</span><span class="n">src_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">wdir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">missing_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Does not exists: &quot;</span> <span class="o">+</span> <span class="n">srcname</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span> 
		
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">wdir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">this_file</span> <span class="o">=</span> <span class="n">wdir</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">this_file</span><span class="p">,</span><span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="s2">&quot;dist_sep&quot;</span><span class="p">,</span><span class="s2">&quot;flux&quot;</span><span class="p">,</span><span class="s2">&quot;flux_err&quot;</span><span class="p">,</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="s2">&quot;index_err&quot;</span><span class="p">,</span><span class="s2">&quot;flux_ul&quot;</span><span class="p">,</span><span class="s2">&quot;TS&quot;</span><span class="p">])</span>
                <span class="n">df_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span><span class="n">df_full</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">df_full</span> <span class="o">=</span> <span class="n">df_full</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;TS&quot;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df_full</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

        <span class="c1"># Write dataframe to text file:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;Preprocessed_Sources/preprocessing_summary_LLAGN.txt&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;*****************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;preprocessing summary:</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">df_full</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;****************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Missing sources:&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">missing_list</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">df_full</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;Preprocessed_Sources/preprocessing_summary_LLAGN.csv&quot;</span><span class="p">,</span><span class="n">sep</span> <span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
        <span class="k">return</span>

    <span class="c1">#################</span>
    <span class="c1"># Stack Sources:</span>

<div class="viewcode-block" id="StackingAnalysis.PL2"><a class="viewcode-back" href="../../fermi_stacking.html#fermi_stacking.fermi_stacking_module.StackingAnalysis.PL2">[docs]</a>    <span class="k">def</span> <span class="nf">PL2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Fit</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">        Power law spectral model for stacking: sets parameters of PowerLaw2 spectral function.</span>
<span class="sd">        Inputs:</span>
<span class="sd">            - Fit: likelihood object.</span>
<span class="sd">            - name: name of source. </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Integral&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="mf">1e-17</span><span class="p">,</span><span class="mf">1e7</span><span class="p">)</span>
        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Integral&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setScale</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Integral&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Integral&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setScale</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;LowerLimit&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">200000</span><span class="p">)</span>
        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;LowerLimit&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emin</span><span class="p">)</span>
        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;LowerLimit&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;LowerLimit&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setScale</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;UpperLimit&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">5000000</span><span class="p">)</span>
        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;UpperLimit&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emax</span><span class="p">)</span>
        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;UpperLimit&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">Fit</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;UpperLimit&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setScale</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Fit</span></div>

<div class="viewcode-block" id="StackingAnalysis.run_stacking"><a class="viewcode-back" href="../../fermi_stacking.html#fermi_stacking.fermi_stacking_module.StackingAnalysis.run_stacking">[docs]</a>    <span class="k">def</span> <span class="nf">run_stacking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">srcname</span><span class="p">,</span><span class="n">PSF</span><span class="p">,</span><span class="n">indir</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Construct 2D TS profiles for sources.</span>

<span class="sd">        inputs:</span>
<span class="sd">            - srcname: name of source.</span>
<span class="sd">            - PSF: integer ranging from 0-3 indicating PSF class for JLA. </span>
<span class="sd">              Note: The passed value is 0 for standard analysis. </span>
<span class="sd">            - indir (optional arguement): input preprocessing directory to use for stacking. </span>
<span class="sd">              Note: Defualt is preprocessing directory from main run directory.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

	<span class="c1"># Make print statement:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;********** Fermi Stacking Analysis **********&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running stacking...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

        <span class="c1"># Define default preprocessing directory:</span>
        <span class="k">if</span> <span class="n">indir</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
            <span class="n">indir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span><span class="s2">&quot;Preprocessed_Sources&quot;</span><span class="p">,</span><span class="n">srcname</span><span class="p">,</span><span class="s2">&quot;output&quot;</span><span class="p">)</span>

        <span class="c1"># Check for updated name:</span>
        <span class="n">replace_name</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">new_name_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span><span class="s2">&quot;replaced_source_name.txt&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_name_file</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">new_name_file</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">this_list</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">true_name</span> <span class="o">=</span> <span class="n">this_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">this_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">replace_name</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Define main output directory for source:</span>
        <span class="n">stacking_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span><span class="s2">&quot;Stacked_Sources&quot;</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">stacking_output</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">stacking_output</span><span class="p">)</span>
       
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">JLA</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">this_src_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stacking_output</span><span class="p">,</span><span class="n">srcname</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">this_src_dir</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">this_src_dir</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">this_src_dir</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">JLA</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">this_likelihood</span> <span class="o">=</span> <span class="s2">&quot;Likelihood_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">PSF</span><span class="p">)</span>
            <span class="n">this_likelihood_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stacking_output</span><span class="p">,</span><span class="n">this_likelihood</span><span class="p">)</span>
            <span class="n">this_src_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">this_likelihood_dir</span><span class="p">,</span><span class="n">srcname</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">this_likelihood_dir</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">this_likelihood_dir</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">this_src_dir</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">this_src_dir</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">this_src_dir</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_scratch</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">this_src_dir</span><span class="p">)</span>

        <span class="c1"># Define scratch directory for source:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_scratch</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">stacking_scratch</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratch</span><span class="p">,</span><span class="s2">&quot;Stacking&quot;</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">stacking_scratch</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">stacking_scratch</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">JLA</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">this_scratch_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stacking_scratch</span><span class="p">,</span><span class="n">srcname</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">this_scratch_dir</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">this_scratch_dir</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">this_scratch_dir</span><span class="p">)</span>
            
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">this_scratch_dir</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">JLA</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">this_likelihood</span> <span class="o">=</span> <span class="s2">&quot;Likelihood_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">PSF</span><span class="p">)</span>
                <span class="n">this_likelihood_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stacking_scratch</span><span class="p">,</span><span class="n">this_likelihood</span><span class="p">)</span>
                <span class="n">this_scratch_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">this_likelihood_dir</span><span class="p">,</span><span class="n">srcname</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">this_likelihood_dir</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">this_likelihood_dir</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">this_scratch_dir</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">this_scratch_dir</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">this_scratch_dir</span><span class="p">)</span>
            
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">this_scratch_dir</span><span class="p">)</span>        
   
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/srcmap_0</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span><span class="n">PSF</span><span class="p">),</span> <span class="s1">&#39;srcmap_0</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span><span class="n">PSF</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/bexpmap_0</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span><span class="n">PSF</span><span class="p">),</span> <span class="s1">&#39;bexpmap_0</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span><span class="n">PSF</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/fit_model_3_0</span><span class="si">%s</span><span class="s1">.xml&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span><span class="n">PSF</span><span class="p">),</span> <span class="s1">&#39;fit_model_3_0</span><span class="si">%s</span><span class="s1">.xml&#39;</span> <span class="o">%</span><span class="n">PSF</span><span class="p">)</span>
	
        <span class="n">obs</span> <span class="o">=</span> <span class="n">BinnedObs</span><span class="p">(</span><span class="n">srcMaps</span><span class="o">=</span><span class="s1">&#39;srcmap_0</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span><span class="n">PSF</span><span class="p">,</span><span class="n">expCube</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ltcube</span><span class="p">,</span><span class="n">binnedExpMap</span><span class="o">=</span><span class="s1">&#39;bexpmap_0</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span><span class="n">PSF</span><span class="p">,</span><span class="n">irfs</span><span class="o">=</span><span class="s1">&#39;P8R3_SOURCE_V2&#39;</span><span class="p">)</span>
	
        <span class="c1"># Define index range for scan:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">index_max</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)):</span>

            <span class="c1"># Fix names for sources with offset positions:</span>
            <span class="k">if</span> <span class="n">replace_name</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">srcname</span> <span class="o">=</span> <span class="n">new_name</span> 
            	
            <span class="n">LOG_LIKE</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">Fit_Qual</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">Conv</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">Flux</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">Index</span><span class="o">=</span><span class="p">[]</span>

            <span class="c1"># Define flux range for scane:</span>
            <span class="n">flux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_max</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_flux_bins</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux</span><span class="p">)):</span>
				
                <span class="n">Index</span><span class="o">+=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
                <span class="n">Flux</span><span class="o">+=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">])]</span>
                <span class="n">like1</span> <span class="o">=</span> <span class="n">BinnedAnalysis</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="s1">&#39;fit_model_3_0</span><span class="si">%s</span><span class="s1">.xml&#39;</span> <span class="o">%</span><span class="n">PSF</span><span class="p">,</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;DRMNFB&#39;</span><span class="p">)</span>
                <span class="n">freeze</span><span class="o">=</span><span class="n">like1</span><span class="o">.</span><span class="n">freeze</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">like1</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">)):</span>
                    <span class="n">freeze</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">like1</span><span class="o">.</span><span class="n">setSpectrum</span><span class="p">(</span><span class="n">srcname</span><span class="p">,</span><span class="s1">&#39;PowerLaw2&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">PL2</span><span class="p">(</span><span class="n">like1</span><span class="p">,</span><span class="n">srcname</span><span class="p">)</span>
                <span class="n">like1</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;galdiff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Prefactor&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">like1</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;galdiff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">like1</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;isodiff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Normalization&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">like1</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">srcname</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Integral&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">like1</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">srcname</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
	            
                <span class="n">like1</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-2</span>
                <span class="n">like1</span><span class="o">.</span><span class="n">syncSrcParams</span><span class="p">()</span>
                <span class="n">likeobj</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">Minuit</span><span class="p">(</span><span class="n">like1</span><span class="o">.</span><span class="n">logLike</span><span class="p">)</span>
                <span class="n">like1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">covar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">optObject</span><span class="o">=</span><span class="n">likeobj</span><span class="p">)</span>
                <span class="n">like1</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">writeXml</span><span class="p">(</span><span class="s1">&#39;fit_1_</span><span class="si">%s</span><span class="s1">.xml&#39;</span> <span class="o">%</span><span class="n">srcname</span><span class="p">)</span>
	                
                <span class="c1">#perform second likelihood fit with Minuit:</span>
                <span class="n">like2</span> <span class="o">=</span> <span class="n">BinnedAnalysis</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="s1">&#39;fit_1_</span><span class="si">%s</span><span class="s1">.xml&#39;</span><span class="o">%</span><span class="n">srcname</span><span class="p">,</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;MINUIT&#39;</span><span class="p">)</span>
	            
                <span class="n">like2</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-8</span>
                <span class="n">like2</span><span class="o">.</span><span class="n">syncSrcParams</span><span class="p">()</span>
                <span class="n">likeobj</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">Minuit</span><span class="p">(</span><span class="n">like2</span><span class="o">.</span><span class="n">logLike</span><span class="p">)</span>
                <span class="n">like2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">covar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">optObject</span><span class="o">=</span><span class="n">likeobj</span><span class="p">)</span>
                <span class="n">Fit_Qual</span><span class="o">+=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">likeobj</span><span class="o">.</span><span class="n">getQuality</span><span class="p">()]</span>
                <span class="n">Conv</span><span class="o">+=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">likeobj</span><span class="o">.</span><span class="n">getRetCode</span><span class="p">()]</span>
                <span class="n">LOG_LIKE</span><span class="o">+=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">like2</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">value</span><span class="p">()]</span>
                <span class="k">del</span> <span class="n">like1</span><span class="p">,</span> <span class="n">like2</span>
		
            <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Flux</span><span class="p">,</span><span class="n">Index</span><span class="p">,</span><span class="n">LOG_LIKE</span><span class="p">,</span><span class="n">Fit_Qual</span><span class="p">,</span><span class="n">Conv</span><span class="p">))</span>
	
            <span class="c1"># Fix names for sources with offset positions:</span>
            <span class="k">if</span> <span class="n">replace_name</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">srcname</span> <span class="o">=</span> <span class="n">true_name</span>

            <span class="c1"># Write Files:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_stacking_</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">srcname</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># Copy files to main output directory:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_scratch</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cp </span><span class="si">%s</span><span class="s1">_stacking_</span><span class="si">%s</span><span class="s1">.txt </span><span class="si">%s</span><span class="s1">/&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">srcname</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">this_src_dir</span><span class="p">))</span>
		
            <span class="c1"># Make more room in RAM:</span>
            <span class="k">del</span> <span class="n">Flux</span><span class="p">,</span><span class="n">Index</span><span class="p">,</span><span class="n">LOG_LIKE</span><span class="p">,</span><span class="n">Fit_Qual</span><span class="p">,</span><span class="n">Conv</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span> <span class="c1">#dump unused memory to speed up calculation</span>
	
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">)</span>
        
        <span class="k">return</span></div>

    <span class="c1">###############</span>
    <span class="c1"># Add Stacking:</span>

<div class="viewcode-block" id="StackingAnalysis.combine_likelihood"><a class="viewcode-back" href="../../fermi_stacking.html#fermi_stacking.fermi_stacking_module.StackingAnalysis.combine_likelihood">[docs]</a>    <span class="k">def</span> <span class="nf">combine_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclusion_list</span><span class="p">,</span> <span class="n">savefile</span><span class="p">):</span>
	
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Make 2D TS profiles for each source and add to get stacked profile.</span>

<span class="sd">	Input definitions:</span>
<span class="sd">            - exclusion_list: list of sources to exclude from stacked profile.</span>
<span class="sd">	    - savefile: Prefix of array to be saved. Do not include &quot;.npy&quot; at the end of the name; it&#39;s already included.</span>
<span class="sd">	</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Make print statement:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Combining likelihood...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

        <span class="c1"># Make main output directories:</span>
        <span class="n">adding_main_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span><span class="s2">&quot;Add_Stacking&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">adding_main_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mkdir </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">adding_main_dir</span><span class="p">)</span>

        <span class="n">array_main_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">adding_main_dir</span><span class="p">,</span><span class="s2">&quot;Numpy_Arrays&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">array_main_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>  
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mkdir </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">array_main_dir</span><span class="p">)</span>
   
        <span class="n">individual_array_main_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">array_main_dir</span><span class="p">,</span><span class="s2">&quot;Individual_Sources&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">individual_array_main_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>  
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mkdir </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">individual_array_main_dir</span><span class="p">)</span>
        
        <span class="n">image_main_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">adding_main_dir</span><span class="p">,</span><span class="s2">&quot;Images&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image_main_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mkdir </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">image_main_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">JLA</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>

	    <span class="c1"># Define counters and lists:</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">print_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">max_TS_list</span> <span class="o">=</span> <span class="p">[]</span>

	    <span class="c1"># Iterate through sources:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_name_list</span><span class="p">)):</span>
			
                <span class="n">srcname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_name_list</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>

                <span class="n">likelihood_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span><span class="s2">&quot;Preprocessed_Sources&quot;</span><span class="p">,</span><span class="n">srcname</span><span class="p">,</span><span class="s2">&quot;output/null_likelihood_0.txt&quot;</span><span class="p">)</span>
                <span class="n">stacking_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span><span class="s2">&quot;Stacked_Sources&quot;</span><span class="p">,</span><span class="n">srcname</span><span class="p">)</span>
	
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stacking_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">likelihood_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">()</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Does not exist: &#39;</span> <span class="o">+</span> <span class="n">srcname</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">srcname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclusion_list</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">lielihood_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stacking_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
				
                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">stacking_dir</span><span class="p">)</span>
	            
                    <span class="n">print_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span>
		
                    <span class="n">array_list</span> <span class="o">=</span> <span class="p">[]</span>
    
                    <span class="c1"># Define index list of scan:</span>
                    <span class="n">index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">index_max</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">index_list</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">index_list</span> <span class="o">=</span> <span class="n">index_list</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            
                    <span class="c1"># Read null likelihood:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">likelihood_dir</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                    <span class="n">null</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">index_list</span><span class="p">)):</span>
                        <span class="n">this_index</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">index_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">this_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_stacking_</span><span class="si">%s</span><span class="s2">.txt&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">srcname</span><span class="p">,</span><span class="n">this_index</span><span class="p">)</span>

                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">this_file</span><span class="p">,</span><span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">,</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="s2">&quot;likelihood&quot;</span><span class="p">,</span><span class="s2">&quot;quality&quot;</span><span class="p">,</span><span class="s2">&quot;status&quot;</span><span class="p">])</span>

                        <span class="n">flux</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
                        <span class="n">likelihood</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;likelihood&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">TS</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;likelihood&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">null</span><span class="p">)</span>
                        <span class="n">TS</span> <span class="o">=</span> <span class="n">TS</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">array_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TS</span><span class="p">)</span>

                    <span class="n">final_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array_list</span><span class="p">)</span>
	
                    <span class="n">this_max_TS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">final_array</span><span class="p">)</span>
                    <span class="n">max_TS_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_max_TS</span><span class="p">)</span>
	
                    <span class="c1"># Save each individual source array:</span>
                    <span class="n">this_file_name</span> <span class="o">=</span> <span class="n">srcname</span> <span class="o">+</span> <span class="s2">&quot;_array&quot;</span>
                    <span class="n">source_array_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">individual_array_main_dir</span><span class="p">,</span><span class="n">this_file_name</span><span class="p">)</span>            	    
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">source_array_file</span><span class="p">,</span><span class="n">final_array</span><span class="p">)</span>

                    <span class="c1"># Get stacked array:</span>
                    <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">summed_array</span> <span class="o">=</span> <span class="n">final_array</span>
                    <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">summed_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">summed_array</span><span class="p">,</span><span class="n">final_array</span><span class="p">)</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sources that were added in the sum:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of sources: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">print_list</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_list</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span> 

            <span class="c1"># Save summed array:</span>
            <span class="n">array_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">array_main_dir</span><span class="p">,</span><span class="n">savefile</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">array_file</span><span class="p">,</span><span class="n">summed_array</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">JLA</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
	
            <span class="c1"># Define counters and lists:</span>
            <span class="n">total_counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">print_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">max_TS_list</span> <span class="o">=</span> <span class="p">[]</span>

	    <span class="c1"># Iterate through sources:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_name_list</span><span class="p">)):</span>
			
                <span class="n">srcname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_name_list</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">j_counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]:</span>
            
                    <span class="n">likelihood_dir</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/null_likelihood_</span><span class="si">%s</span><span class="s2">.txt&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">srcname</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
                    <span class="n">likelihood_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span><span class="n">likelihood_dir</span><span class="p">)</span>
                    <span class="n">stacking_dir</span> <span class="o">=</span> <span class="s2">&quot;Stacked_Sources/Likelihood_</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="n">srcname</span><span class="p">)</span>
                    <span class="n">stacking_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span><span class="n">stacking_dir</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stacking_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">likelihood_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">()</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Does not exist: &#39;</span> <span class="o">+</span> <span class="n">srcname</span> <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">()</span> 
                        <span class="n">j_counter</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">srcname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclusion_list</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">likelihood_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stacking_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
				
                        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">stacking_dir</span><span class="p">)</span>

                        <span class="n">array_list</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="c1"># Define index list of scan:</span>
                        <span class="n">index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">index_max</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">)</span>
                        <span class="n">index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">index_list</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">index_list</span> <span class="o">=</span> <span class="n">index_list</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        
                        <span class="c1"># Read null likelihood:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">likelihood_dir</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                        <span class="n">null</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">index_list</span><span class="p">)):</span>
                            <span class="n">this_index</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">index_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                            <span class="n">this_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_stacking_</span><span class="si">%s</span><span class="s2">.txt&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">srcname</span><span class="p">,</span><span class="n">this_index</span><span class="p">)</span>
                        
                            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">this_file</span><span class="p">,</span><span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">,</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="s2">&quot;likelihood&quot;</span><span class="p">,</span><span class="s2">&quot;quality&quot;</span><span class="p">,</span><span class="s2">&quot;status&quot;</span><span class="p">])</span>
                        
                            <span class="n">flux</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
                            <span class="n">likelihood</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;likelihood&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                            <span class="n">TS</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;likelihood&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">null</span><span class="p">)</span>
                            <span class="n">TS</span> <span class="o">=</span> <span class="n">TS</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                            <span class="n">array_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TS</span><span class="p">)</span>
                        
                        <span class="n">final_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array_list</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">summed_array</span> <span class="o">=</span> <span class="n">final_array</span>
                        <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">summed_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">summed_array</span><span class="p">,</span><span class="n">final_array</span><span class="p">)</span>
                        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            
                <span class="k">if</span> <span class="n">srcname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclusion_list</span> <span class="ow">and</span> <span class="n">j_counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="n">print_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span>

	            <span class="c1"># Save each individual source array:</span>
                    <span class="n">source_array_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">individual_array_main_dir</span><span class="p">,</span><span class="n">srcname</span><span class="p">)</span>            	    
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">source_array_file</span><span class="p">,</span><span class="n">summed_array</span><span class="p">)</span>

                    <span class="c1"># Get stacked array:</span>
                    <span class="k">if</span> <span class="n">total_counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">total_summed_array</span> <span class="o">=</span> <span class="n">summed_array</span>
                    <span class="k">if</span> <span class="n">total_counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">total_summed_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">total_summed_array</span><span class="p">,</span><span class="n">summed_array</span><span class="p">)</span>
                    <span class="n">total_counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sources that were added in the sum:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of sources: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">print_list</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_list</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span> 

            <span class="c1"># Save summed array:</span>
            <span class="n">array_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">array_main_dir</span><span class="p">,</span><span class="n">savefile</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">array_file</span><span class="p">,</span><span class="n">total_summed_array</span><span class="p">)</span>

        <span class="c1"># Return to home:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">)</span>
		
        <span class="k">return</span> 	</div>

    <span class="c1">#############</span>
    <span class="c1"># Make plots:</span>

<div class="viewcode-block" id="StackingAnalysis.plot_final_array"><a class="viewcode-back" href="../../fermi_stacking.html#fermi_stacking.fermi_stacking_module.StackingAnalysis.plot_final_array">[docs]</a>    <span class="k">def</span> <span class="nf">plot_final_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">savefig</span><span class="p">,</span><span class="n">array</span><span class="p">,</span><span class="n">use_index</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	 </span>
<span class="sd">         Input definitions:</span>
<span class="sd">	 </span>
<span class="sd">	 savefig: Name of image file to be saved. </span>
<span class="sd">	</span>
<span class="sd">	 array: Name of input array to plot. Must include &quot;.npy&quot;.</span>
<span class="sd">	</span>
<span class="sd">         use_index (optional_arguement): option to calculate flux for specified index.</span>
<span class="sd">            Note: default is best-fit index.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Make print statement:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plotting final_array...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        
        <span class="c1"># Specify the savefigure:</span>
        <span class="n">savefig</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Add_Stacking/Images/&quot;</span><span class="p">,</span><span class="n">savefig</span><span class="p">)</span>
        
        <span class="c1"># Specify array file to be plotted: </span>
        <span class="n">array_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Add_Stacking/Numpy_Arrays/&quot;</span><span class="p">,</span><span class="n">array</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">array_file</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">array_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Add_Stacking/Numpy_Arrays/Individual_Sources/&quot;</span><span class="p">,</span><span class="n">array</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">array_file</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: array file does not exists.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        
        <span class="c1"># Setup figure:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        
        <span class="c1"># Upload summed array:</span>
        <span class="n">summed_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">array_file</span><span class="p">)</span>
        
        <span class="c1"># Get min and max:</span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">summed_array</span><span class="p">)</span>
        <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">summed_array</span><span class="p">)</span>
        
        <span class="c1"># Corresponding sigma for 2 dof:</span>
        <span class="n">num_pars</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">stats</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">max_value</span><span class="p">,</span><span class="n">num_pars</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        
        <span class="c1"># Significane contours for dof=2:</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">max_value</span> <span class="o">-</span> <span class="mf">2.3</span> <span class="c1"># 0.68 level</span>
        <span class="n">second</span> <span class="o">=</span> <span class="n">max_value</span> <span class="o">-</span> <span class="mf">4.61</span> <span class="c1"># 0.90 level</span>
        <span class="n">third</span> <span class="o">=</span>  <span class="n">max_value</span> <span class="o">-</span> <span class="mf">9.21</span> <span class="c1"># 0.99 level</span>
        
        <span class="c1"># Find indices for max values:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">summed_array</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span><span class="n">summed_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">best_index_value</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">best_flux_value</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Get best index:</span>
        <span class="n">index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">index_max</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">)</span>     
        <span class="n">best_index</span> <span class="o">=</span> <span class="n">index_list</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        
        <span class="c1"># Get best flux:</span>
        <span class="n">flux_list</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_max</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">flux_list</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">flux_list</span> 
        <span class="n">best_flux</span> <span class="o">=</span> <span class="n">flux_list</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        
        <span class="c1"># Option to calculate flux for specified index:</span>
        <span class="k">if</span> <span class="n">use_index</span> <span class="o">!=</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
            <span class="n">index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">index_list</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">best_index_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index_list</span><span class="o">==</span><span class="n">use_index</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">summed_array</span><span class="p">[</span><span class="n">best_index_value</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span><span class="n">summed_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">best_flux_value</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">best_index</span> <span class="o">=</span> <span class="n">index_list</span><span class="p">[</span><span class="n">best_index_value</span><span class="p">]</span>
            <span class="n">best_flux</span> <span class="o">=</span> <span class="n">flux_list</span><span class="p">[</span><span class="n">best_flux_value</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_index_value</span><span class="p">,</span><span class="n">best_flux_value</span><span class="p">)</span>
            <span class="n">max_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">summed_array</span><span class="p">[</span><span class="n">best_index_value</span><span class="p">])</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">stats</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">max_value</span><span class="p">,</span><span class="n">num_pars</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        
        <span class="c1"># Smooth array:</span>
        <span class="n">gauss_kernel</span> <span class="o">=</span> <span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="n">filtered_arr</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">summed_array</span><span class="p">,</span> <span class="n">gauss_kernel</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;extend&#39;</span><span class="p">)</span>
        
        <span class="c1"># Below I define 3 different methods to plot the array, just with different styles.</span>
        <span class="c1"># Use method 1 as the default.</span>
        
	<span class="c1"># Method 1</span>
        <span class="k">def</span> <span class="nf">plot_method_1</span><span class="p">():</span>
            
            <span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">flux_list</span><span class="p">,</span><span class="n">index_list</span><span class="p">,</span><span class="n">summed_array</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">max_value</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">flux_list</span><span class="p">,</span><span class="n">index_list</span><span class="p">,</span><span class="n">summed_array</span><span class="p">,</span><span class="n">levels</span> <span class="o">=</span> <span class="p">(</span><span class="n">third</span><span class="p">,</span><span class="n">second</span><span class="p">,</span><span class="n">first</span><span class="p">),</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linestyles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="s2">&quot;-&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="mf">4.0</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">best_flux</span><span class="p">,</span><span class="n">best_index</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">img</span>

	<span class="c1"># Method 2 </span>
        <span class="k">def</span> <span class="nf">plot_method_2</span><span class="p">():</span>
            
            <span class="c1">#clip the array at zero for visualization purposes:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">summed_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            	<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">summed_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            	    <span class="k">if</span> <span class="n">summed_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            	        <span class="n">summed_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">flux_list</span><span class="p">,</span><span class="n">index_list</span><span class="p">,</span><span class="n">summed_array</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">flux_list</span><span class="p">,</span><span class="n">index_list</span><span class="p">,</span><span class="n">summed_array</span><span class="p">,</span><span class="n">levels</span> <span class="o">=</span> <span class="p">(</span><span class="n">third</span><span class="p">,</span><span class="n">second</span><span class="p">,</span><span class="n">first</span><span class="p">),</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linestyles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="s2">&quot;-&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">best_flux</span><span class="p">,</span><span class="n">best_index</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">img</span>

	<span class="c1"># Method 3</span>
        <span class="k">def</span> <span class="nf">plot_method_3</span><span class="p">():</span>

            <span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">summed_array</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">max_value</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">summed_array</span><span class="p">,</span><span class="n">levels</span> <span class="o">=</span> <span class="p">(</span><span class="n">third</span><span class="p">,</span><span class="n">second</span><span class="p">,</span><span class="n">first</span><span class="p">),</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linestyles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="s2">&quot;-&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">img</span>
        
        <span class="c1"># Make plot with this method:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">plot_method_1</span><span class="p">()</span>
        
        <span class="c1"># Plot colorbar</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.045</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;TS&quot;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Photon Index&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mathregular{\gamma}$-Ray Flux [ph $\mathrm{cm^2}$  s$\mathregular{^{-1}}$]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span> <span class="c1">#for flux</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_plots</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1">#################</span>
        <span class="c1"># Find 1 sigma error from the 2d array</span>
        
        <span class="c1"># Important note: the for loop is constrained to scan the respective list only once;</span>
        <span class="c1"># Otherwise it will loop through numerous times.</span>
        
        <span class="c1"># Get 1 sigma index upper error (lower direction of map):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">index_list</span><span class="p">)</span><span class="o">-</span><span class="n">best_index_value</span><span class="p">):</span>
	
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">summed_array</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">][</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">max_value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">2.3</span><span class="p">:</span>
                <span class="k">pass</span> 
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">summed_array</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">][</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">max_value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">2.3</span><span class="p">:</span>
                <span class="n">index_sigma_upper</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">index_list</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">index_list</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">])</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index_list</span><span class="p">)</span><span class="o">-</span><span class="n">best_index_value</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">index_sigma_upper</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#in this case the index is not constrained toward bottom of map</span>

	<span class="c1"># Get 1 sigma index lower error (upper direction of map):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">best_index_value</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">summed_array</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">j</span><span class="p">][</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">max_value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">2.3</span><span class="p">:</span>
            	<span class="k">pass</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">summed_array</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">j</span><span class="p">][</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">max_value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">2.3</span><span class="p">:</span>
            	<span class="n">index_sigma_lower</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">index_list</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">index_list</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">j</span><span class="p">])</span>
            	<span class="k">break</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">best_index_value</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            	<span class="n">index_sigma_lower</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#in this case the index is not constrained toward top of map</span>
            	
                    
        <span class="c1"># Get 1 sigma flux upper error:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">flux_list</span><span class="p">)</span><span class="o">-</span><span class="n">best_flux_value</span><span class="p">):</span>
                    
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">summed_array</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">2.3</span><span class="p">:</span>
            	<span class="k">pass</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">summed_array</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">2.3</span><span class="p">:</span>
            	<span class="n">flux_sigma_upper</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">flux_list</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">flux_list</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">])</span>
            	<span class="k">break</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index_list</span><span class="p">)</span><span class="o">-</span><span class="n">best_index_value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            	<span class="n">flux_sigma_upper</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#in this case the flux is not constrained toward right of map</span>
                    
        <span class="c1"># Get 1 sigma flux lower error:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">best_flux_value</span><span class="p">):</span>
                    
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">summed_array</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">2.3</span><span class="p">:</span>
            	<span class="k">pass</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">summed_array</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">2.3</span><span class="p">:</span>
            	<span class="n">flux_sigma_lower</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">flux_list</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">flux_list</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">j</span><span class="p">])</span>
            	<span class="k">break</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">best_flux_value</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            	<span class="n">flux_sigma_lower</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#in this case the index is not constrained toward left of map</span>
                    
        <span class="nb">print</span><span class="p">()</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;max TS: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_value</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;; sigma: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;indices for max TS: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sanity check on indices: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">summed_array</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best index: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">best_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, Error:  +&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index_sigma_upper</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, -&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index_sigma_lower</span><span class="p">))</span>  
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best flux: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">best_flux</span><span class="p">)</span>  <span class="o">+</span> <span class="s2">&quot;, Error: +&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">flux_sigma_upper</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, -&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">flux_sigma_lower</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>
        
        <span class="k">return</span></div>

<div class="viewcode-block" id="StackingAnalysis.power_law_2"><a class="viewcode-back" href="../../fermi_stacking.html#fermi_stacking.fermi_stacking_module.StackingAnalysis.power_law_2">[docs]</a>    <span class="k">def</span> <span class="nf">power_law_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">gamma</span><span class="p">,</span><span class="n">E</span><span class="p">,</span><span class="n">Emin</span><span class="p">,</span><span class="n">Emax</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        </span>
<span class="sd">        dN/dE in units of ph/cm^s/s/MeV.</span>
<span class="sd">            Inputs:</span>
<span class="sd">            N: Integrated flux between Emin and Emax in ph/cm^2/s.</span>
<span class="sd">            gamma: Spectral index.</span>
<span class="sd">            E: Energy range in MeV. Should be array.</span>
<span class="sd">            Emin, Emax: Min and max energy, respectively, in MeV. </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
            
        <span class="k">return</span> <span class="n">N</span><span class="o">*</span><span class="p">(</span><span class="n">gamma</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">E</span><span class="o">**</span><span class="n">gamma</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Emax</span><span class="o">**</span><span class="p">(</span><span class="n">gamma</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">Emin</span><span class="o">**</span><span class="p">(</span><span class="n">gamma</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span></div>
    

<div class="viewcode-block" id="StackingAnalysis.make_butterfly"><a class="viewcode-back" href="../../fermi_stacking.html#fermi_stacking.fermi_stacking_module.StackingAnalysis.make_butterfly">[docs]</a>    <span class="k">def</span> <span class="nf">make_butterfly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
       
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        </span>
<span class="sd">        Calculate butterfly plot.</span>
<span class="sd">            </span>
<span class="sd">        Inputs:</span>
<span class="sd">            name: name of input array (not including .npy).</span>
<span class="sd">                Note: this name is also used for output files. </span>
<span class="sd">            numbins: number of energy bins to use for butterfly plot.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
	
        <span class="c1"># Make print statement:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Making butterfly plot...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        
        <span class="n">conv</span> <span class="o">=</span> <span class="mf">1.60218e-6</span> <span class="c1"># MeV to erg</span>
        
        <span class="c1"># Make output directories and file:</span>
        <span class="n">image_output</span> <span class="o">=</span> <span class="s2">&quot;Add_Stacking/Images/&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_butterfly.pdf&quot;</span>
        
        <span class="n">output_data_dir</span> <span class="o">=</span> <span class="s2">&quot;Add_Stacking/Output_Data&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_data_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mkdir </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">output_data_dir</span><span class="p">)</span>
        <span class="n">data_output</span> <span class="o">=</span> <span class="s2">&quot;Add_Stacking/Output_Data/&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_butterfly.dat&quot;</span>
        
        <span class="c1"># Define energy range and binning for butterfly plot:</span>
        <span class="n">E_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emin</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emax</span><span class="p">),</span><span class="mi">30</span><span class="p">)</span> 
        
        <span class="c1"># Define flux and index.</span>
        <span class="c1"># Must be the same that was used to make the stacked array. </span>
        <span class="n">flux_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_max</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">flux_list</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">flux_list</span>
        <span class="n">index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">index_max</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">)</span>
        
        <span class="c1"># Load stacked array:</span>
        <span class="n">input_array</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Add_Stacking/Numpy_Arrays/&quot;</span><span class="p">,</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">input_array</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">input_array</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Add_Stacking/Numpy_Arrays/Individual_Sources/&quot;</span><span class="p">,</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">input_array</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: array file does not exists.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="n">this_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">input_array</span><span class="p">)</span>
        
        <span class="c1"># Find indices for max values:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">this_array</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span><span class="n">this_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">best_index</span> <span class="o">=</span> <span class="n">index_list</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">best_flux</span> <span class="o">=</span> <span class="n">flux_list</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        
        <span class="c1"># Get max and significane contours for dof=2:</span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">this_array</span><span class="p">)</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">max_value</span> <span class="o">-</span> <span class="mf">2.3</span> <span class="c1">#0.68 level</span>
        <span class="n">second</span> <span class="o">=</span> <span class="n">max_value</span> <span class="o">-</span> <span class="mf">4.61</span> <span class="c1">#0.90 level</span>
        <span class="n">third</span> <span class="o">=</span>  <span class="n">max_value</span> <span class="o">-</span> <span class="mf">9.21</span> <span class="c1">#0.99 level</span>
        
        <span class="c1"># Get indices within 1sigma contour:</span>
        <span class="n">contour</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">this_array</span><span class="o">&gt;=</span><span class="n">first</span><span class="p">)</span>
        
        <span class="c1"># Test Method 1:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">flux_list</span><span class="p">,</span><span class="n">index_list</span><span class="p">,</span><span class="n">this_array</span><span class="p">,</span><span class="n">levels</span> <span class="o">=</span> <span class="p">(</span><span class="n">third</span><span class="p">,</span><span class="n">second</span><span class="p">,</span><span class="n">first</span><span class="p">),</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linestyles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="s2">&quot;-&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="mf">4.0</span><span class="p">)</span>
        <span class="c1">#this_array[contour] = 0</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">flux_list</span><span class="p">,</span><span class="n">index_list</span><span class="p">,</span><span class="n">this_array</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">max_value</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Flux [$\mathrm{ph \ cm^{-2} \ s^{-1}}$]&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Index&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Setup figure:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        
        <span class="c1"># Plot solutions within 1 sigma contour (sanity check):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">contour</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">contour</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
            <span class="n">this_N</span> <span class="o">=</span> <span class="n">flux_list</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">this_gamma</span> <span class="o">=</span> <span class="n">index_list</span><span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">*-</span><span class="mi">1</span>
            <span class="n">dnde</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_law_2</span><span class="p">(</span><span class="n">this_N</span><span class="p">,</span><span class="n">this_gamma</span><span class="p">,</span><span class="n">E_range</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">emin</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">emax</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">E_range</span><span class="p">,</span><span class="n">conv</span><span class="o">*</span><span class="n">E_range</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dnde</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        
        <span class="c1"># Interpolate array for plotting:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">flux_list</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">index_list</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">this_array</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
        
        <span class="c1"># Use finer binning to fill out butterfly plot:</span>
        <span class="n">plot_flux_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_max</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plot_flux_list</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">plot_flux_list</span>
        <span class="n">plot_index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">index_max</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.003</span><span class="p">)</span>
        
        <span class="c1"># Plot best-fit:</span>
        <span class="n">this_N</span> <span class="o">=</span> <span class="n">best_flux</span>
        <span class="n">this_gamma</span> <span class="o">=</span> <span class="n">best_index</span><span class="o">*-</span><span class="mi">1</span>
        <span class="n">dnde</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_law_2</span><span class="p">(</span><span class="n">this_N</span><span class="p">,</span><span class="n">this_gamma</span><span class="p">,</span><span class="n">E_range</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">emin</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">emax</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">E_range</span><span class="p">,</span><span class="n">conv</span><span class="o">*</span><span class="n">E_range</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dnde</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">best_flux</span> <span class="o">=</span> <span class="n">conv</span><span class="o">*</span><span class="n">E_range</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dnde</span>
        
        <span class="c1"># Plot butterfly:</span>
        <span class="n">plot_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">plot_flux_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">every</span> <span class="ow">in</span> <span class="n">plot_index_list</span><span class="p">:</span>
                
                <span class="n">this_flux</span> <span class="o">=</span> <span class="n">each</span>
                <span class="n">this_index</span> <span class="o">=</span> <span class="n">every</span>
                <span class="n">this_TS</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">this_flux</span><span class="p">,</span><span class="n">this_index</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">this_TS</span> <span class="o">&gt;=</span> <span class="n">first</span><span class="p">:</span>
                    <span class="n">this_N</span> <span class="o">=</span> <span class="n">each</span>
                    <span class="n">this_gamma</span> <span class="o">=</span> <span class="n">every</span><span class="o">*-</span><span class="mi">1</span>
                    <span class="n">dnde</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_law_2</span><span class="p">(</span><span class="n">this_N</span><span class="p">,</span><span class="n">this_gamma</span><span class="p">,</span><span class="n">E_range</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">emin</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">emax</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">E_range</span><span class="p">,</span><span class="n">conv</span><span class="o">*</span><span class="n">E_range</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dnde</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conv</span><span class="o">*</span><span class="n">E_range</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dnde</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mathrm{E^2 dN/dE \ [erg \ cm^{-2} \ s^{-1}]}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Energy [MeV]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span> <span class="c1">#for flux</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>                        
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">5e-16</span><span class="p">,</span><span class="mf">5e-11</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">image_output</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Write butterfly to data using max and min values: </span>
        <span class="n">plot_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plot_list</span><span class="p">)</span>
        <span class="n">plot_list</span> <span class="o">=</span> <span class="n">plot_list</span><span class="o">.</span><span class="n">T</span>
        <span class="n">min_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">max_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">plot_list</span><span class="p">:</span>
            <span class="n">this_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">each</span><span class="p">)</span>
            <span class="n">this_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">each</span><span class="p">)</span>
            <span class="n">min_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_min</span><span class="p">)</span>
            <span class="n">max_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_max</span><span class="p">)</span>
        
        <span class="c1"># Check if source is too bright to make a butterfly plot:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: butterfly plot is empty! Setting to best-fit.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This typically implies that the source is very bright, with very small error contours.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
        
            <span class="n">min_list</span> <span class="o">=</span> <span class="n">best_flux</span>
            <span class="n">max_list</span> <span class="o">=</span> <span class="n">best_flux</span>
        
        <span class="c1"># Write data file:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Energy[MeV]&quot;</span><span class="p">:</span><span class="n">E_range</span><span class="p">,</span><span class="s2">&quot;Flux[erg/cm^2/s]&quot;</span><span class="p">:</span><span class="n">best_flux</span><span class="p">,</span><span class="s2">&quot;Flux_min[erg/cm^2/s]&quot;</span><span class="p">:</span><span class="n">min_list</span><span class="p">,</span><span class="s2">&quot;Flux_max[erg/cm^2/s]&quot;</span><span class="p">:</span><span class="n">max_list</span><span class="p">}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="p">,</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Energy[MeV]&quot;</span><span class="p">,</span><span class="s2">&quot;Flux[erg/cm^2/s]&quot;</span><span class="p">,</span><span class="s2">&quot;Flux_min[erg/cm^2/s]&quot;</span><span class="p">,</span><span class="s2">&quot;Flux_max[erg/cm^2/s]&quot;</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">data_output</span><span class="p">,</span><span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%10.5e</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="k">return</span></div>

<div class="viewcode-block" id="StackingAnalysis.get_stack_UL95"><a class="viewcode-back" href="../../fermi_stacking.html#fermi_stacking.fermi_stacking_module.StackingAnalysis.get_stack_UL95">[docs]</a>    <span class="k">def</span> <span class="nf">get_stack_UL95</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_file</span><span class="p">,</span> <span class="n">ul_index</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	</span>
<span class="sd">        Calculate one-sided 95% UL from the 2D TS arrays: 2(logL_max - logL) = 2.71.</span>
<span class="sd">        Note: Since the TS array is used, the factor of 2 is already included in the calculation!</span>
<span class="sd">        This methed is not applicable if TS&lt;1.</span>
<span class="sd">	The default index is set to -2.0.</span>

<span class="sd">	Inputs definitions:</span>

<span class="sd">	array_file: 2D array to calculate UL from</span>

<span class="sd">        ul_index (optional arguement): spectral index to use for UL calculation.</span>
<span class="sd">            Note: Default value is 2.0.</span>
<span class="sd">	</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="c1"># Make print statement:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running get_UL...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        
        <span class="n">this_array</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Add_Stacking/Numpy_Arrays/&quot;</span><span class="p">,</span><span class="n">array_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">this_array</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">this_array</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Add_Stacking/Numpy_Arrays/Individual_Sources/&quot;</span><span class="p">,</span><span class="n">array_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">this_array</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: array file does not exists.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        
        <span class="n">summed_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">this_array</span><span class="p">)</span>
        
        <span class="c1"># Define flux list:</span>
        <span class="n">flux_list</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_max</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">flux_list</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">flux_list</span> 
        
        <span class="c1"># Get index arguement for UL calculation:</span>
        <span class="n">index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">index_max</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">index_list</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ul_arg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index_list</span><span class="o">==</span><span class="n">ul_index</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating UL for spectral index = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ul_index</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>
        
        <span class="c1"># Extract row from 2d summed array corresponding to the UL index:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">summed_array</span><span class="p">[</span><span class="n">ul_arg</span><span class="p">]</span>
        <span class="n">profile</span> <span class="o">=</span>  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span><span class="o">-</span> <span class="n">profile</span><span class="p">)</span>
        <span class="n">flux_interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">flux_list</span><span class="p">,</span><span class="n">profile</span><span class="p">,</span><span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
        
        <span class="c1"># Plot profile:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mf">6.2</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">flux_list</span><span class="p">,</span><span class="n">profile</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;95% UL&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">flux_list</span><span class="p">,</span><span class="n">flux_interp</span><span class="p">(</span><span class="n">flux_list</span><span class="p">),</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span> <span class="c1">#,label=&quot;interpolation&quot;)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="mf">2.71</span><span class="p">,</span><span class="mf">1e-13</span><span class="p">,</span><span class="mf">1e-9</span><span class="p">,</span><span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;dashdot&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$\gamma$-ray Flux [$\mathrm{ph \ cm^{-2} \ s^{-1}}$]&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;2($\mathrm{logL_</span><span class="si">{max}</span><span class="s2"> - logL}$)&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Profile Likelihood&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;Add_Stacking/Images/likelihood_profile.png&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Find min of function and corresponding x at min:</span>
        <span class="c1"># Note: the last entry is the staring point for x, and it needs to be close to the min to converge. </span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;****************&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="n">min_x</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">flux_interp</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1e-10</span><span class="p">]),</span><span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">upper</span> <span class="o">=</span> <span class="mf">7e-10</span>
        <span class="n">error_right</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">brenth</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">flux_interp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mf">2.71</span><span class="p">,</span><span class="n">min_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upper</span><span class="p">,</span><span class="n">xtol</span><span class="o">=</span><span class="mf">1e-13</span><span class="p">)</span> <span class="c1"># right</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Results:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;best flux: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">min_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; ph/cm^2/s&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error right: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_right</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; ph/cm^2/s&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;95</span><span class="si">% F</span><span class="s2">lux UL: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_right</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; ph/cm^2/s&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>	
        
        <span class="k">return</span></div>
        
<div class="viewcode-block" id="StackingAnalysis.calc_upper_limit"><a class="viewcode-back" href="../../fermi_stacking.html#fermi_stacking.fermi_stacking_module.StackingAnalysis.calc_upper_limit">[docs]</a>    <span class="k">def</span> <span class="nf">calc_upper_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">srcname</span><span class="p">,</span><span class="n">ul_emin</span><span class="p">,</span><span class="n">ul_emax</span><span class="p">,</span><span class="n">comp_list</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span><span class="n">mult_lt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        	
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>
<span class="sd">	 Calculate upper limits using both a bayesian approach and a frequentist approach using results from preprocessing.</span>
<span class="sd">	</span>
<span class="sd">	 The frequentist appraoch uses the profile likelihood method, with 2.71/2 for 95% UL. This is standard in LAT analysis. </span>
<span class="sd">	 However, when there is a physical boundary on a parameter (such as a normalization) the profile likelihood is always restricted </span>
<span class="sd">	 to the physical region such that for a negative MLE the maximum is evaluated at zero.</span>
<span class="sd">	 	</span>
<span class="sd">	 For low significant sources the bayesian approach may be a better estimate (Thanks to Jean Ballet for pointing this out).</span>

<span class="sd">         Inputs:</span>

<span class="sd">         srcname: Name of source for UL calculation.</span>

<span class="sd">         ul_emin: Lower energy bound for UL calculation.</span>

<span class="sd">         ul_emax: Upper energy bound for UL calculation.</span>

<span class="sd">         comp_list (optional): List of components to add to the SummedLikelihood object for the JLA. </span>
<span class="sd">            Note: Default is for typical JLA with 4 components. </span>
<span class="sd">            Note: The added components must be defined in the energy range of the UL calculation.</span>
<span class="sd">            Note: The function supports up to 10 components (0-9). For more, further definitions must be added.</span>

<span class="sd">        mult_lt (optional): If using lt cubes for each component, set to True. Default is False, for single lt cube. </span>

<span class="sd">	&#39;&#39;&#39;</span>      
        
        <span class="c1"># Make print statement:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;calculating upper limit...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        
        <span class="c1"># Check that the included components are ok:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">JLA</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">each</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***ERROR***&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Looks like you have a complex analysis!&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;More than 9 components is not currently supported.&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You&#39;ll need to add more definitions to the source code.&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">()</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Components included in the UL calculation: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comp_list</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">()</span> 
        
        <span class="c1"># Check for updated name:</span>
        <span class="n">preprocess_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span><span class="s2">&quot;Preprocessed_Sources&quot;</span><span class="p">,</span><span class="n">srcname</span><span class="p">,</span><span class="s2">&quot;output&quot;</span><span class="p">)</span>
        <span class="n">replace_name</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">new_name_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preprocess_dir</span><span class="p">,</span><span class="s2">&quot;replaced_source_name.txt&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_name_file</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">new_name_file</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">this_list</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">true_name</span> <span class="o">=</span> <span class="n">this_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">this_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">replace_name</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># Define the lt cube:</span>
        <span class="c1"># Note: this will be overwritten for the JLA if mult_lt is set to True.</span>
        <span class="n">my_expCube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ltcube</span>
        
        <span class="c1"># Analysis selections (fixed for now):</span>
        <span class="n">irfs</span> <span class="o">=</span> <span class="s2">&quot;P8R3_SOURCE_V2&quot;</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="s2">&quot;Minuit&quot;</span> <span class="c1"># Minuit or NewMinuit</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">BinnedConfig</span><span class="p">(</span><span class="n">edisp_bins</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#need to account for energy dispersion!</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">JLA</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        
            <span class="c1"># Make the summedlikelihood object:</span>
            <span class="n">summed_like</span> <span class="o">=</span> <span class="n">SummedLikelihood</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mult_lt</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">my_expCube</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/ltcube_00.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_ExpMap_0</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/bexpmap_roi_00.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_src_0</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/srcmap_00.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span> 
                <span class="n">my_xml_0</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/fit_model_3_00.xml&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">obs_0</span> <span class="o">=</span> <span class="n">BinnedObs</span><span class="p">(</span><span class="n">srcMaps</span><span class="o">=</span><span class="n">my_src_0</span><span class="p">,</span> <span class="n">expCube</span><span class="o">=</span><span class="n">my_expCube</span><span class="p">,</span> <span class="n">binnedExpMap</span><span class="o">=</span><span class="n">my_ExpMap_0</span><span class="p">,</span><span class="n">irfs</span><span class="o">=</span><span class="n">irfs</span><span class="p">)</span>
                <span class="n">like0</span> <span class="o">=</span> <span class="n">BinnedAnalysis</span><span class="p">(</span><span class="n">obs_0</span><span class="p">,</span> <span class="n">my_xml_0</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span>
                <span class="n">like0</span><span class="o">.</span><span class="n">setEnergyRange</span><span class="p">(</span><span class="n">ul_emin</span><span class="p">,</span><span class="n">ul_emax</span><span class="p">)</span>
                <span class="n">summed_like</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">like0</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mult_lt</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">my_expCube</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/ltcube_01.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_ExpMap_1</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/bexpmap_roi_01.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_src_1</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/srcmap_01.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_xml_1</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/fit_model_3_01.xml&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">obs_1</span> <span class="o">=</span> <span class="n">BinnedObs</span><span class="p">(</span><span class="n">srcMaps</span><span class="o">=</span><span class="n">my_src_1</span><span class="p">,</span> <span class="n">expCube</span><span class="o">=</span><span class="n">my_expCube</span><span class="p">,</span> <span class="n">binnedExpMap</span><span class="o">=</span><span class="n">my_ExpMap_1</span><span class="p">,</span><span class="n">irfs</span><span class="o">=</span><span class="n">irfs</span><span class="p">)</span>
                <span class="n">like1</span> <span class="o">=</span> <span class="n">BinnedAnalysis</span><span class="p">(</span><span class="n">obs_1</span><span class="p">,</span> <span class="n">my_xml_1</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span>
                <span class="n">like1</span><span class="o">.</span><span class="n">setEnergyRange</span><span class="p">(</span><span class="n">ul_emin</span><span class="p">,</span><span class="n">ul_emax</span><span class="p">)</span>
                <span class="n">summed_like</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">like1</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="mi">2</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mult_lt</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">my_expCube</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/ltcube_02.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_ExpMap_2</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/bexpmap_roi_02.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_src_2</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/srcmap_02.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span> 
                <span class="n">my_xml_2</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/fit_model_3_02.xml&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">obs_2</span> <span class="o">=</span> <span class="n">BinnedObs</span><span class="p">(</span><span class="n">srcMaps</span><span class="o">=</span><span class="n">my_src_2</span><span class="p">,</span> <span class="n">expCube</span><span class="o">=</span><span class="n">my_expCube</span><span class="p">,</span> <span class="n">binnedExpMap</span><span class="o">=</span><span class="n">my_ExpMap_2</span><span class="p">,</span><span class="n">irfs</span><span class="o">=</span><span class="n">irfs</span><span class="p">)</span>
                <span class="n">like2</span> <span class="o">=</span> <span class="n">BinnedAnalysis</span><span class="p">(</span><span class="n">obs_2</span><span class="p">,</span> <span class="n">my_xml_2</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span>
                <span class="n">like2</span><span class="o">.</span><span class="n">setEnergyRange</span><span class="p">(</span><span class="n">ul_emin</span><span class="p">,</span><span class="n">ul_emax</span><span class="p">)</span>
                <span class="n">summed_like</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">like2</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="mi">3</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mult_lt</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">my_expCube</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/ltcube_03.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_ExpMap_3</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/bexpmap_roi_03.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_src_3</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/srcmap_03.fits&quot;</span>   <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_xml_3</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/fit_model_3_03.xml&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">obs_3</span> <span class="o">=</span> <span class="n">BinnedObs</span><span class="p">(</span><span class="n">srcMaps</span><span class="o">=</span><span class="n">my_src_3</span><span class="p">,</span> <span class="n">expCube</span><span class="o">=</span><span class="n">my_expCube</span><span class="p">,</span> <span class="n">binnedExpMap</span><span class="o">=</span><span class="n">my_ExpMap_3</span><span class="p">,</span><span class="n">irfs</span><span class="o">=</span><span class="n">irfs</span><span class="p">)</span>
                <span class="n">like3</span> <span class="o">=</span> <span class="n">BinnedAnalysis</span><span class="p">(</span><span class="n">obs_3</span><span class="p">,</span> <span class="n">my_xml_3</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span>
                <span class="n">like3</span><span class="o">.</span><span class="n">setEnergyRange</span><span class="p">(</span><span class="n">ul_emin</span><span class="p">,</span><span class="n">ul_emax</span><span class="p">)</span>
                <span class="n">summed_like</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">like3</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="mi">4</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mult_lt</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">my_expCube</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/ltcube_04.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_ExpMap_4</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/bexpmap_roi_04.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_src_4</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/srcmap_04.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span> 
                <span class="n">my_xml_4</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/fit_model_3_04.xml&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">obs_4</span> <span class="o">=</span> <span class="n">BinnedObs</span><span class="p">(</span><span class="n">srcMaps</span><span class="o">=</span><span class="n">my_src_4</span><span class="p">,</span> <span class="n">expCube</span><span class="o">=</span><span class="n">my_expCube</span><span class="p">,</span> <span class="n">binnedExpMap</span><span class="o">=</span><span class="n">my_ExpMap_4</span><span class="p">,</span><span class="n">irfs</span><span class="o">=</span><span class="n">irfs</span><span class="p">)</span>
                <span class="n">like4</span> <span class="o">=</span> <span class="n">BinnedAnalysis</span><span class="p">(</span><span class="n">obs_4</span><span class="p">,</span> <span class="n">my_xml_4</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span>
                <span class="n">like4</span><span class="o">.</span><span class="n">setEnergyRange</span><span class="p">(</span><span class="n">ul_emin</span><span class="p">,</span><span class="n">ul_emax</span><span class="p">)</span>
                <span class="n">summed_like</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">like4</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="mi">5</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mult_lt</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">my_expCube</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/ltcube_05.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_ExpMap_5</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/bexpmap_roi_05.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_src_5</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/srcmap_05.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_xml_5</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/fit_model_3_05.xml&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">obs_5</span> <span class="o">=</span> <span class="n">BinnedObs</span><span class="p">(</span><span class="n">srcMaps</span><span class="o">=</span><span class="n">my_src_5</span><span class="p">,</span> <span class="n">expCube</span><span class="o">=</span><span class="n">my_expCube</span><span class="p">,</span> <span class="n">binnedExpMap</span><span class="o">=</span><span class="n">my_ExpMap_5</span><span class="p">,</span><span class="n">irfs</span><span class="o">=</span><span class="n">irfs</span><span class="p">)</span>
                <span class="n">like5</span> <span class="o">=</span> <span class="n">BinnedAnalysis</span><span class="p">(</span><span class="n">obs_5</span><span class="p">,</span> <span class="n">my_xml_5</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span>
                <span class="n">like5</span><span class="o">.</span><span class="n">setEnergyRange</span><span class="p">(</span><span class="n">ul_emin</span><span class="p">,</span><span class="n">ul_emax</span><span class="p">)</span>
                <span class="n">summed_like</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">like5</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="mi">6</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mult_lt</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">my_expCube</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/ltcube_06.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_ExpMap_6</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/bexpmap_roi_06.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_src_6</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/srcmap_06.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span> 
                <span class="n">my_xml_6</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/fit_model_3_06.xml&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">obs_6</span> <span class="o">=</span> <span class="n">BinnedObs</span><span class="p">(</span><span class="n">srcMaps</span><span class="o">=</span><span class="n">my_src_6</span><span class="p">,</span> <span class="n">expCube</span><span class="o">=</span><span class="n">my_expCube</span><span class="p">,</span> <span class="n">binnedExpMap</span><span class="o">=</span><span class="n">my_ExpMap_6</span><span class="p">,</span><span class="n">irfs</span><span class="o">=</span><span class="n">irfs</span><span class="p">)</span>
                <span class="n">like6</span> <span class="o">=</span> <span class="n">BinnedAnalysis</span><span class="p">(</span><span class="n">obs_6</span><span class="p">,</span> <span class="n">my_xml_6</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span>
                <span class="n">like6</span><span class="o">.</span><span class="n">setEnergyRange</span><span class="p">(</span><span class="n">ul_emin</span><span class="p">,</span><span class="n">ul_emax</span><span class="p">)</span>
                <span class="n">summed_like</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">like6</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="mi">7</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mult_lt</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">my_expCube</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/ltcube_07.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_ExpMap_7</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/bexpmap_roi_07.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_src_7</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/srcmap_07.fits&quot;</span>   <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_xml_7</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/fit_model_3_07.xml&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">obs_7</span> <span class="o">=</span> <span class="n">BinnedObs</span><span class="p">(</span><span class="n">srcMaps</span><span class="o">=</span><span class="n">my_src_7</span><span class="p">,</span> <span class="n">expCube</span><span class="o">=</span><span class="n">my_expCube</span><span class="p">,</span> <span class="n">binnedExpMap</span><span class="o">=</span><span class="n">my_ExpMap_7</span><span class="p">,</span><span class="n">irfs</span><span class="o">=</span><span class="n">irfs</span><span class="p">)</span>
                <span class="n">like7</span> <span class="o">=</span> <span class="n">BinnedAnalysis</span><span class="p">(</span><span class="n">obs_7</span><span class="p">,</span> <span class="n">my_xml_7</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span>
                <span class="n">like7</span><span class="o">.</span><span class="n">setEnergyRange</span><span class="p">(</span><span class="n">ul_emin</span><span class="p">,</span><span class="n">ul_emax</span><span class="p">)</span>
                <span class="n">summed_like</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">like7</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="mi">8</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mult_lt</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">my_expCube</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/ltcube_08.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_ExpMap_8</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/bexpmap_roi_08.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_src_8</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/srcmap_08.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span> 
                <span class="n">my_xml_8</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/fit_model_3_08.xml&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">obs_8</span> <span class="o">=</span> <span class="n">BinnedObs</span><span class="p">(</span><span class="n">srcMaps</span><span class="o">=</span><span class="n">my_src_8</span><span class="p">,</span> <span class="n">expCube</span><span class="o">=</span><span class="n">my_expCube</span><span class="p">,</span> <span class="n">binnedExpMap</span><span class="o">=</span><span class="n">my_ExpMap_8</span><span class="p">,</span><span class="n">irfs</span><span class="o">=</span><span class="n">irfs</span><span class="p">)</span>
                <span class="n">like8</span> <span class="o">=</span> <span class="n">BinnedAnalysis</span><span class="p">(</span><span class="n">obs_8</span><span class="p">,</span> <span class="n">my_xml_8</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span>
                <span class="n">like8</span><span class="o">.</span><span class="n">setEnergyRange</span><span class="p">(</span><span class="n">ul_emin</span><span class="p">,</span><span class="n">ul_emax</span><span class="p">)</span>
                <span class="n">summed_like</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">like8</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="mi">9</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mult_lt</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">my_expCube</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/ltcube_09.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_ExpMap_9</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/bexpmap_roi_09.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_src_9</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/srcmap_09.fits&quot;</span>   <span class="o">%</span><span class="n">srcname</span>
                <span class="n">my_xml_9</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/fit_model_3_09.xml&quot;</span> <span class="o">%</span><span class="n">srcname</span>
                <span class="n">obs_9</span> <span class="o">=</span> <span class="n">BinnedObs</span><span class="p">(</span><span class="n">srcMaps</span><span class="o">=</span><span class="n">my_src_9</span><span class="p">,</span> <span class="n">expCube</span><span class="o">=</span><span class="n">my_expCube</span><span class="p">,</span> <span class="n">binnedExpMap</span><span class="o">=</span><span class="n">my_ExpMap_9</span><span class="p">,</span><span class="n">irfs</span><span class="o">=</span><span class="n">irfs</span><span class="p">)</span>
                <span class="n">like9</span> <span class="o">=</span> <span class="n">BinnedAnalysis</span><span class="p">(</span><span class="n">obs_9</span><span class="p">,</span> <span class="n">my_xml_9</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span>
                <span class="n">like9</span><span class="o">.</span><span class="n">setEnergyRange</span><span class="p">(</span><span class="n">ul_emin</span><span class="p">,</span><span class="n">ul_emax</span><span class="p">)</span>
                <span class="n">summed_like</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">like9</span><span class="p">)</span>
        
            <span class="n">summedobj</span><span class="o">=</span><span class="n">pyLike</span><span class="o">.</span><span class="n">Minuit</span><span class="p">(</span><span class="n">summed_like</span><span class="o">.</span><span class="n">logLike</span><span class="p">)</span>
        
            <span class="c1"># Update name:</span>
            <span class="k">if</span> <span class="n">replace_name</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">srcname</span> <span class="o">=</span> <span class="n">new_name</span>
        
            <span class="c1"># Fix parameters: </span>
            <span class="n">freeze</span><span class="o">=</span><span class="n">summed_like</span><span class="o">.</span><span class="n">freeze</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">summed_like</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">)):</span>
                <span class="n">freeze</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        
            <span class="c1"># Set index=2.0 for UL calculation:</span>
            <span class="n">summed_like</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">srcname</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">summed_like</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">srcname</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
         
            <span class="c1"># Get TS of source:</span>
            <span class="n">src_TS</span> <span class="o">=</span> <span class="n">summed_like</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span>
        
            <span class="c1"># Calculate 95% ULs using frequentist approach:</span>
            <span class="n">ul</span> <span class="o">=</span> <span class="n">UpperLimits</span><span class="p">(</span><span class="n">summed_like</span><span class="p">)</span>	
            <span class="n">ul</span><span class="p">[</span><span class="n">srcname</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">emin</span><span class="o">=</span><span class="n">ul_emin</span><span class="p">,</span><span class="n">emax</span><span class="o">=</span><span class="n">ul_emax</span><span class="p">)</span>	
        
            <span class="c1"># Calculate 95% bayesian UL:</span>
            <span class="n">bays_ul</span><span class="p">,</span><span class="n">results</span> <span class="o">=</span> <span class="n">calc_int</span><span class="p">(</span><span class="n">summed_like</span><span class="p">,</span><span class="n">srcname</span><span class="p">,</span><span class="n">emin</span><span class="o">=</span><span class="n">ul_emin</span><span class="p">,</span> <span class="n">emax</span><span class="o">=</span><span class="n">ul_emax</span><span class="p">,</span><span class="n">cl</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">JLA</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            
            <span class="n">my_ExpMap_0</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/bexpmap_roi_00.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span>
            <span class="n">my_src_0</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/srcmap_00.fits&quot;</span> <span class="o">%</span><span class="n">srcname</span> 
            <span class="n">my_xml_0</span> <span class="o">=</span> <span class="s2">&quot;Preprocessed_Sources/</span><span class="si">%s</span><span class="s2">/output/fit_model_3_00.xml&quot;</span> <span class="o">%</span><span class="n">srcname</span>
            <span class="n">obs_0</span> <span class="o">=</span> <span class="n">BinnedObs</span><span class="p">(</span><span class="n">srcMaps</span><span class="o">=</span><span class="n">my_src_0</span><span class="p">,</span> <span class="n">expCube</span><span class="o">=</span><span class="n">my_expCube</span><span class="p">,</span> <span class="n">binnedExpMap</span><span class="o">=</span><span class="n">my_ExpMap_0</span><span class="p">,</span><span class="n">irfs</span><span class="o">=</span><span class="n">irfs</span><span class="p">)</span>
            <span class="n">like0</span> <span class="o">=</span> <span class="n">BinnedAnalysis</span><span class="p">(</span><span class="n">obs_0</span><span class="p">,</span> <span class="n">my_xml_0</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span>
            <span class="n">like0</span><span class="o">.</span><span class="n">setEnergyRange</span><span class="p">(</span><span class="n">ul_emin</span><span class="p">,</span><span class="n">ul_emax</span><span class="p">)</span>
        
            <span class="n">likeobj</span><span class="o">=</span><span class="n">pyLike</span><span class="o">.</span><span class="n">Minuit</span><span class="p">(</span><span class="n">like0</span><span class="o">.</span><span class="n">logLike</span><span class="p">)</span>
        
            <span class="c1"># Update name:</span>
            <span class="k">if</span> <span class="n">replace_name</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">srcname</span> <span class="o">=</span> <span class="n">new_name</span>
        
            <span class="c1"># Fix parameters: </span>
            <span class="n">freeze</span><span class="o">=</span><span class="n">like0</span><span class="o">.</span><span class="n">freeze</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">like0</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">)):</span>
                <span class="n">freeze</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            
            <span class="c1"># Set index=2.0 for UL calculation:</span>
            <span class="n">like0</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">srcname</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">like0</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">srcname</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        
            <span class="c1"># Calculate ULs using frequentist approach:</span>
            <span class="n">ul</span> <span class="o">=</span> <span class="n">UpperLimits</span><span class="p">(</span><span class="n">like0</span><span class="p">)</span>	
            <span class="n">ul</span><span class="p">[</span><span class="n">srcname</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">emin</span><span class="o">=</span><span class="n">ul_emin</span><span class="p">,</span><span class="n">emax</span><span class="o">=</span><span class="n">ul_emax</span><span class="p">)</span>	
        
            <span class="c1"># Calculate bayesian UL:</span>
            <span class="n">bays_ul</span><span class="p">,</span><span class="n">results</span> <span class="o">=</span> <span class="n">calc_int</span><span class="p">(</span><span class="n">like0</span><span class="p">,</span><span class="n">srcname</span><span class="p">,</span><span class="n">emin</span><span class="o">=</span><span class="n">ul_emin</span><span class="p">,</span> <span class="n">emax</span><span class="o">=</span><span class="n">ul_emax</span><span class="p">,</span><span class="n">cl</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span>
        
        <span class="c1"># Convert ul to float:</span>
        <span class="n">this_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ul</span><span class="p">[</span><span class="n">srcname</span><span class="p">]</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">this_string</span> <span class="o">=</span> <span class="n">this_string</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>	
        <span class="n">freq_ul</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">this_string</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;##########&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Source TS: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">src_TS</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Frequentist 95% UL&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ul</span><span class="p">[</span><span class="n">srcname</span><span class="p">]</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bayesian 95% ULs:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bays_ul</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; ph/cm^2/s&quot;</span><span class="p">)</span> 
        <span class="nb">print</span><span class="p">()</span> 
        
        <span class="k">return</span> <span class="n">freq_ul</span><span class="p">,</span> <span class="n">bays_ul</span> </div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">fermi_stacking</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../fermi_stacking.html">Fermi Stacking</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2024, Chris Karwin.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>